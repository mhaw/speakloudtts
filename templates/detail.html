{% extends "base.html" %}

{% block head %}
  {# Open Graph & Twitter Player tags for rich media on mobile #}
  <meta property="og:title"         content="{{ item.title }}">
  <meta property="og:description"   content="Listen to the audio version of {{ item.title }}">
  <meta property="og:url"           content="{{ request.url }}">
  {% if item.favicon_url %}
  <meta property="og:image"         content="{{ item.favicon_url }}">
  {% endif %}
  <meta property="og:type"          content="music.song">
  <meta property="og:audio"         content="{{ item.audio_url }}">
  <meta property="og:audio:type"    content="audio/mpeg">
  <meta name="twitter:card"         content="player">
  <meta name="twitter:player:stream" content="{{ item.audio_url }}">
{% endblock %}

{% block content %}
  <!-- Sticky header -->
  <div class="sticky top-0 bg-white dark:bg-gray-900 z-30 border-b border-gray-200 dark:border-gray-700">
    <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0">
      <!-- Back + Title -->
      <div>
        <a href="/items" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 mb-2 inline-block">
          â† Back to all articles
        </a>
        <div class="flex items-center space-x-2">
          {% if item.favicon_url %}
            <img src="{{ item.favicon_url }}" class="w-6 h-6" alt="">
          {% endif %}
          <h1 class="text-2xl sm:text-3xl font-bold text-primary">{{ item.title }}</h1>
        </div>
        <p class="text-gray-600 dark:text-gray-400 text-sm sm:text-base mt-1">
          By <strong>{{ item.author or "Unknown" }}</strong>
          {% if item.publish_date_fmt %}| {{ item.publish_date_fmt }}{% endif %}
          | {{ item.word_count }} words
          | ~{{ item.reading_time_min }} min read
        </p>
      </div>

      <!-- Audio + Controls -->
      <div class="w-full md:w-auto space-y-2">
        <audio id="audio-player" controls class="w-full rounded-lg shadow-sm" src="{{ item.audio_url }}"></audio>
        <div class="flex items-center justify-center space-x-4 mt-2">
          <button id="rewind-btn" class="px-3 py-1 bg-gray-200 rounded dark:bg-gray-700 text-sm">Â« 15s</button>
          <div class="flex items-center space-x-2">
            <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
          </div>
          <button id="forward-btn" class="px-3 py-1 bg-gray-200 rounded dark:bg-gray-700 text-sm">30s Â»</button>
        </div>
        <div class="flex items-center justify-between text-sm mt-2">
          <div class="flex items-center space-x-2">
            <span>Speed:</span>
            <button data-rate="0.75" class="speed-btn px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">0.75Ã—</button>
            <button data-rate="1"    class="speed-btn px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">1Ã—</button>
            <button data-rate="1.25" class="speed-btn px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">1.25Ã—</button>
            <button data-rate="1.5"  class="speed-btn px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">1.5Ã—</button>
          </div>
        </div>
        <progress id="audio-progress" value="0" max="100" class="w-full h-2 rounded bg-gray-200 dark:bg-gray-700"></progress>
      </div>
    </div>
  </div>

  <div id="main-content" class="pt-6 container mx-auto px-4 space-y-6">
    <!-- Transcript download & copy -->
    <div class="flex space-x-4 mb-4 text-sm">
      <a href="/items/{{ item.id }}/text"
         download="{{ item.id }}.txt"
         class="text-primary hover:underline">ğŸ“„ Download Transcript</a>
      <button id="copy-transcript" class="text-primary hover:underline">ğŸ“‹ Copy Transcript</button>
    </div>

    <!-- Share buttons -->
    <div class="flex flex-wrap items-center space-x-4 text-sm mb-4">
      <button id="copy-article-url" class="flex items-center space-x-1 text-primary hover:underline">
        <span>ğŸ“‹</span><span>Copy article URL</span>
      </button>
      <button id="copy-audio-url" class="flex items-center space-x-1 text-primary hover:underline">
        <span>ğŸ§</span><span>Copy audio link</span>
      </button>
      <button id="copy-feed-url" class="flex items-center space-x-1 text-primary hover:underline">
        <span>ğŸ”—</span><span>Copy RSS feed URL</span>
      </button>
    </div>

    <!-- Metadata & Tags -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <details class="bg-white p-4 rounded shadow dark:bg-gray-800">
        <summary class="cursor-pointer font-medium">Metadata</summary>
        <ul class="mt-2 list-disc list-inside text-sm text-gray-700 dark:text-gray-300 space-y-1">
          <li><strong>Original URL:</strong>
            <a href="{{ item.url }}" target="_blank" class="text-primary hover:underline">{{ item.url }}</a>
          </li>
          <li><strong>Publish Date:</strong> {{ item.publish_date_fmt or "N/A" }}</li>
          <li><strong>Last Modified:</strong> {{ item.last_modified or "N/A" }}</li>
          <li><strong>ETag:</strong> {{ item.etag or "N/A" }}</li>
        </ul>
      </details>
      <div>
        <label class="block font-medium mb-1">Tags:</label>
        <div id="tags-display" class="flex flex-wrap space-x-2">
          {% for tag in item.tags %}
            <span class="bg-gray-200 text-sm px-2 py-1 rounded dark:bg-gray-700">{{ tag }}</span>
          {% endfor %}
          {% if not item.tags %}<span class="text-gray-500">None</span>{% endif %}
        </div>
        <button id="edit-tags-btn" class="mt-2 text-sm text-primary hover:underline">âœï¸ Edit Tags</button>
        <div id="tags-editor" class="mt-2 space-x-2 hidden">
          <input type="text" id="tags-input"
                 class="px-3 py-1 border rounded w-2/3 dark:bg-gray-700 dark:border-gray-600"
                 value="{{ item.tags|join(',') }}"
                 placeholder="comma,separated,tags">
          <button id="save-tags-btn" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
            Save
          </button>
          <button id="cancel-tags-btn" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400 text-sm">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Font-size controls -->
    <div class="flex items-center justify-end space-x-2 mb-4 text-sm">
      <span class="font-medium">Text size:</span>
      <button id="font-small"  class="px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">A-</button>
      <button id="font-normal" class="px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">A</button>
      <button id="font-large"  class="px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">A+</button>
    </div>

    <!-- Article body -->
    {% set paras = item.text.split('\n\n') %}
    {% if paras|length <= 1 %}{% set paras = item.text.splitlines() %}{% endif %}
    <article id="full-text"
             class="prose prose-lg max-w-none space-y-8 bg-white p-6 rounded shadow dark:prose-invert dark:bg-gray-800">
      {% for para in paras %}
        {% if para.strip() %}
          <p class="paragraph">{{ para|e }}</p>
        {% endif %}
      {% endfor %}
    </article>
  </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const audio        = document.getElementById('audio-player'),
        prog         = document.getElementById('audio-progress'),
        paras        = Array.from(document.querySelectorAll('#full-text .paragraph')),
        speeds       = Array.from(document.querySelectorAll('.speed-btn')),
        curTimeEl    = document.getElementById('current-time'),
        totalTimeEl  = document.getElementById('total-time'),
        copyTransBtn = document.getElementById('copy-transcript'),
        copyArticle  = document.getElementById('copy-article-url'),
        copyAudio    = document.getElementById('copy-audio-url'),
        copyFeed     = document.getElementById('copy-feed-url'),
        editBtn      = document.getElementById('edit-tags-btn'),
        editor       = document.getElementById('tags-editor'),
        display      = document.getElementById('tags-display'),
        input        = document.getElementById('tags-input'),
        saveBtn      = document.getElementById('save-tags-btn'),
        cancelBtn    = document.getElementById('cancel-tags-btn'),
        fontSmall    = document.getElementById('font-small'),
        fontNorm     = document.getElementById('font-normal'),
        fontLarge    = document.getElementById('font-large'),
        rewindBtn    = document.getElementById('rewind-btn'),
        forwardBtn   = document.getElementById('forward-btn'),
        transcript   = paras.map(p => p.textContent).join('\n\n'),
        storageKey   = 'playbackPos-{{ item.id }}';

  let boundaries = [], lastIdx = -1;

  // Build time-boundaries
  audio.addEventListener('loadedmetadata', () => {
    const savedPos = parseFloat(localStorage.getItem(storageKey));
    if (!isNaN(savedPos)) audio.currentTime = Math.min(savedPos, audio.duration-0.1);

    // highlight logic
    const introLen = (`Title: {{ item.title }}. By {{ item.author or 'Unknown' }}.`).length;
    const lens = paras.map(p => p.textContent.length);
    const totalLen = introLen + lens.reduce((a,b)=>a+b,0);
    let acc = introLen;
    boundaries = lens.map(len => {
      const t = (acc/totalLen)*audio.duration;
      acc += len;
      return t;
    });

    const m = Math.floor(audio.duration/60),
          s = String(Math.floor(audio.duration%60)).padStart(2,'0');
    totalTimeEl.textContent = `${m}:${s}`;
  });

  // Timeupdate: highlight + save
  audio.addEventListener('timeupdate', () => {
    const t = audio.currentTime;
    localStorage.setItem(storageKey, t);
    prog.value = (t/audio.duration)*100;

    let idx = boundaries.findIndex(b => t <= b);
    if (idx < 0) idx = boundaries.length - 1;
    if (idx !== lastIdx) {
      paras.forEach((p,i) => p.classList.toggle('bg-yellow-100', i===idx));
      paras.forEach((p,i) => p.classList.toggle('dark:bg-yellow-800', i===idx));
      paras.forEach((p,i) => p.classList.toggle('p-2', i===idx));
      paras.forEach((p,i) => p.classList.toggle('rounded', i===idx));
      if (idx >= 0) paras[idx].scrollIntoView({behavior:'smooth',block:'center'});
      lastIdx = idx;
    }
    curTimeEl.textContent = `${String(Math.floor(t/60))}:${String(Math.floor(t%60)).padStart(2,'0')}`;
  });

  // Seek bar
  prog.addEventListener('click', e => {
    const pct = e.offsetX / prog.offsetWidth;
    audio.currentTime = pct * audio.duration;
  });

  // Speed controls
  function setSpeed(r) {
    audio.playbackRate = r;
    speeds.forEach(b => b.classList.toggle('bg-primary', +b.dataset.rate===r));
    localStorage.setItem('playbackRate',''+r);
  }
  const savedRate = parseFloat(localStorage.getItem('playbackRate'));
  setSpeed(isNaN(savedRate)?1:savedRate);
  speeds.forEach(b=>b.addEventListener('click', ()=>setSpeed(+b.dataset.rate)));

  // Skip backward/forward
  rewindBtn.addEventListener('click', () => audio.currentTime = Math.max(0, audio.currentTime - 15));
  forwardBtn.addEventListener('click', () => audio.currentTime = Math.min(audio.duration, audio.currentTime + 30));

  // Copy transcript
  copyTransBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(transcript)
      .then(() => copyTransBtn.textContent = 'âœ“ Copied')
      .catch(() => copyTransBtn.textContent = 'âœ— Failed')
      .finally(() => setTimeout(() => copyTransBtn.textContent = 'ğŸ“‹ Copy Transcript', 1500));
  });

  // Copy URLs
  function copySimple(txt, btn) {
    navigator.clipboard.writeText(txt)
      .then(() => btn.textContent = 'âœ“ Copied')
      .catch(() => btn.textContent = 'âœ— Failed')
      .finally(() => setTimeout(() => btn.textContent = btn.dataset.label, 1500));
  }
  copyArticle.dataset.label = copyArticle.textContent;
  copyAudio.dataset.label   = copyAudio.textContent;
  copyFeed.dataset.label    = copyFeed.textContent;
  copyArticle.addEventListener('click',()=>copySimple("{{ item.url }}", copyArticle));
  copyAudio.addEventListener('click',()=>copySimple("{{ item.audio_url }}", copyAudio));
  copyFeed.addEventListener('click',()=>copySimple("{{ request.url_root }}feed.xml", copyFeed));

  // Tag editor
  editBtn.addEventListener('click', ()=>{ editor.classList.remove('hidden'); editBtn.classList.add('hidden'); });
  cancelBtn.addEventListener('click', ()=>{ editor.classList.add('hidden'); editBtn.classList.remove('hidden'); });
  saveBtn.addEventListener('click', async () => {
    const tags = input.value.split(',').map(t=>t.trim()).filter(Boolean);
    saveBtn.disabled = true;
    try {
      const res = await fetch(`/api/items/{{ item.id }}/tags`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({tags})
      });
      if (!res.ok) throw new Error((await res.json()).error||res.statusText);
      display.innerHTML = tags.length
        ? tags.map(t=>`<span class="bg-gray-200 text-sm px-2 py-1 rounded dark:bg-gray-700">${t}</span>`).join('')
        : '<span class="text-gray-500">None</span>';
      editor.classList.add('hidden');
      editBtn.classList.remove('hidden');
    } catch(err) {
      alert('Error saving tags: '+err.message);
    } finally { saveBtn.disabled=false; }
  });

  // Font size
  fontSmall.addEventListener('click', ()=> {
    const art = document.getElementById('full-text');
    art.classList.replace('prose-lg','text-sm');
    art.classList.remove('text-xl');
  });
  fontNorm.addEventListener('click', ()=> {
    const art = document.getElementById('full-text');
    art.classList.remove('text-sm','text-xl');
    art.classList.add('prose-lg');
  });
  fontLarge.addEventListener('click', ()=> {
    const art = document.getElementById('full-text');
    art.classList.remove('prose-lg','text-sm');
    art.classList.add('text-xl');
  });
});
</script>
{% endblock %}