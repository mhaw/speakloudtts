{% extends "base.html" %}
{% block content %}
  <div class="max-w-xl mx-auto">
    <h2 class="text-2xl font-semibold mb-4">Submit an Article URL</h2>

    <form id="submit-form" class="space-y-4">
      <input
        type="url"
        id="url-input"
        placeholder="https://example.com/article"
        class="w-full px-4 py-2 border rounded focus:ring focus:ring-primary"
        required
      >
      <button
        type="submit"
        id="submit-btn"
        disabled
        class="w-full flex justify-center items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
      >
        <span id="btn-text">Convert to Audio</span>
      </button>
    </form>

    <div id="status" class="mt-4 min-h-[2em] text-center text-sm"></div>

    <!-- Recent submissions -->
    <div class="mt-8">
      <h3 class="text-lg font-medium mb-2">Recent Articles</h3>
      <ul id="recent-list" class="list-disc list-inside text-primary space-y-1">
        <!-- populated by JS -->
      </ul>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const urlInput  = document.getElementById('url-input');
    const submitBtn = document.getElementById('submit-btn');
    const btnText   = document.getElementById('btn-text');
    const statusDiv = document.getElementById('status');

    // 1) instant URL validation
    urlInput.addEventListener('input', () => {
      submitBtn.disabled = !urlInput.validity.valid;
    });

    // 2) form submission
    document.getElementById('submit-form').addEventListener('submit', async e => {
      e.preventDefault();
      submitBtn.disabled = true;
      btnText.innerHTML = `
        <svg class="animate-spin h-5 w-5 mr-2 text-white" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10"
                  stroke="currentColor" stroke-width="4" fill="none"/>
          <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8v8H4z"/>
        </svg>
        Processing…`;

      try {
        statusDiv.textContent = 'Extracting text…';
        const url = urlInput.value;
        const res = await fetch('/submit', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({url})
        });

        // 3) update step
        statusDiv.textContent = 'Generating audio…';

        const data = await res.json();
        if (!res.ok) throw new Error(data.detail||data.error);

        // success
        window.location.href = '/items';
      } catch(err) {
        statusDiv.innerHTML = `<span class="text-red-600">Error: ${err.message}</span>`;
        // restore button
        submitBtn.disabled = false;
        btnText.textContent = 'Convert to Audio';
      }
    });

    // 4) fetch & render recent submissions
    fetch('/api/recent')
      .then(r => r.json())
      .then(items => {
        const list = document.getElementById('recent-list');
        if (!items.length) {
          list.innerHTML = '<li class="text-gray-500">No recent submissions</li>';
          return;
        }
        items.slice(0,5).forEach(it => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="/items/${it.id}"
                               class="hover:underline">
                            ${it.title || it.url}
                          </a>`;
          list.appendChild(li);
        });
      })
      .catch(()=> {
        document.getElementById('recent-list')
                .innerHTML = '<li class="text-gray-500">Unable to load recent items</li>';
      });
  });
  </script>
{% endblock %}