{% extends "base.html" %}

{% block content %}
  <!-- Sticky header with back link, title, byline, audio & controls -->
  <div class="sticky top-0 bg-white dark:bg-gray-900 z-30 border-b border-gray-200 dark:border-gray-700">
    <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0">
      <div>
        <a href="/items" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 mb-2 inline-block">
          ‚Üê Back to all articles
        </a>
        <div class="flex items-center space-x-2">
          {% if item.favicon_url %}
            <img src="{{ item.favicon_url }}" alt="" class="w-6 h-6">
          {% endif %}
          <h1 class="text-2xl sm:text-3xl font-bold text-primary">
            {{ item.title }}
          </h1>
        </div>
        <p class="text-gray-600 dark:text-gray-400 text-sm sm:text-base mt-1">
          By <strong>{{ item.author or "Unknown" }}</strong>
          {% if item.publish_date_fmt %}| {{ item.publish_date_fmt }}{% endif %}
          | {{ item.word_count }} words
          | ~{{ item.reading_time_min }} min read
        </p>
      </div>
      <div class="w-full md:w-auto space-y-2">
        <audio id="audio-player" controls class="w-full rounded-lg shadow-sm"
               src="{{ item.audio_url }}"></audio>
        <div class="flex items-center justify-between text-sm">
          <div class="flex items-center space-x-2">
            <span>Speed:</span>
            <button data-rate="0.75" class="speed-btn px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">0.75√ó</button>
            <button data-rate="1"    class="speed-btn px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">1√ó</button>
            <button data-rate="1.25" class="speed-btn px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">1.25√ó</button>
            <button data-rate="1.5"  class="speed-btn px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">1.5√ó</button>
          </div>
          <div class="flex items-center space-x-2">
            <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
          </div>
        </div>
        <progress id="audio-progress" value="0" max="100"
                  class="w-full h-2 rounded bg-gray-200 dark:bg-gray-700"></progress>
      </div>
    </div>
  </div>

  <div id="main-content" class="pt-6 container mx-auto px-4 space-y-6">

    <!-- Share buttons -->
    <div class="flex flex-wrap items-center space-x-4 text-sm">
      <button id="copy-article-url" class="flex items-center space-x-1 text-primary hover:underline">
        <span>üìã</span><span>Copy article URL</span>
      </button>
      <button id="copy-audio-url" class="flex items-center space-x-1 text-primary hover:underline">
        <span>üéß</span><span>Copy audio link</span>
      </button>
      <button id="copy-feed-url" class="flex items-center space-x-1 text-primary hover:underline">
        <span>üîó</span><span>Copy RSS feed URL</span>
      </button>
    </div>

    <!-- Metadata & Tags -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <details class="bg-white p-4 rounded shadow dark:bg-gray-800">
        <summary class="cursor-pointer font-medium">Metadata</summary>
        <ul class="mt-2 list-disc list-inside text-sm text-gray-700 dark:text-gray-300 space-y-1">
          <li><strong>Original URL:</strong>
            <a href="{{ item.url }}" target="_blank" class="text-primary hover:underline">{{ item.url }}</a>
          </li>
          <li><strong>Publish Date:</strong> {{ item.publish_date_fmt or "N/A" }}</li>
          <li><strong>Last Modified:</strong> {{ item.last_modified or "N/A" }}</li>
          <li><strong>ETag:</strong> {{ item.etag or "N/A" }}</li>
        </ul>
      </details>
      <div>
        <label class="block font-medium mb-1">Tags:</label>
        <div id="tags-display" class="flex flex-wrap space-x-2">
          {% for tag in item.tags %}
            <span class="bg-gray-200 text-sm px-2 py-1 rounded dark:bg-gray-700">{{ tag }}</span>
          {% endfor %}
          {% if not item.tags %}
            <span class="text-gray-500">None</span>
          {% endif %}
        </div>
        <button id="edit-tags-btn" class="mt-2 text-sm text-primary hover:underline">
          ‚úèÔ∏è Edit Tags
        </button>
        <div id="tags-editor" class="mt-2 space-x-2 hidden">
          <input type="text" id="tags-input"
                 class="px-3 py-1 border rounded w-2/3 dark:bg-gray-700 dark:border-gray-600"
                 value="{{ item.tags|join(',') }}"
                 placeholder="comma,separated,tags">
          <button id="save-tags-btn"
                  class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
            Save
          </button>
          <button id="cancel-tags-btn"
                  class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400 text-sm">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Download link & font-size controls -->
    <div class="flex items-center justify-between space-x-4">
      <a href="{{ item.audio_url }}" download class="text-primary hover:underline text-sm">
        ‚¨áÔ∏è Download Audio
      </a>
      <div class="flex items-center space-x-2 text-sm">
        <span class="font-medium">Text size:</span>
        <button id="font-small"  class="px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">A-</button>
        <button id="font-normal" class="px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">A</button>
        <button id="font-large"  class="px-2 py-1 bg-gray-200 rounded dark:bg-gray-700">A+</button>
      </div>
    </div>

    <!-- Split into paragraphs -->
    {% set paras = item.text.split('\n\n') %}
    {% if paras|length <= 1 %}
      {% set paras = item.text.splitlines() %}
    {% endif %}

    <!-- Article Text -->
    <article id="full-text"
             class="prose prose-lg max-w-none space-y-8 bg-white p-6 rounded shadow dark:prose-invert dark:bg-gray-800">
      {% for para in paras %}
        {% if para.strip() %}
          <p class="paragraph">{{ para|e }}</p>
        {% endif %}
      {% endfor %}
    </article>
  </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // DOM refs
  const audio = document.getElementById('audio-player'),
        prog  = document.getElementById('audio-progress'),
        paras = Array.from(document.querySelectorAll('#full-text .paragraph')),
        speeds = Array.from(document.querySelectorAll('.speed-btn')),
        curTimeEl = document.getElementById('current-time'),
        totalTimeEl = document.getElementById('total-time');

  // build speed options array
  const rateOptions = speeds.map(b => parseFloat(b.dataset.rate));

  // helper to set speed
  function setSpeed(rate) {
    audio.playbackRate = rate;
    localStorage.setItem('playbackRate', rate);
    speeds.forEach(btn => {
      btn.classList.toggle('bg-primary', parseFloat(btn.dataset.rate) === rate);
    });
  }

  // apply saved speed (or default 1√ó)
  const saved = parseFloat(localStorage.getItem('playbackRate'));
  setSpeed(rateOptions.includes(saved) ? saved : 1);

  // wire up speed buttons
  speeds.forEach(btn => {
    btn.addEventListener('click', () => setSpeed(parseFloat(btn.dataset.rate)));
  });

  // compute paragraph time‚Äêboundaries once metadata loads
  let boundaries = [], lastIdx = -1;
  audio.addEventListener('loadedmetadata', () => {
    const dur = audio.duration;
    // include intro length (we skip highlighting intro)
    const introLen = (`Title: {{ item.title }}. By {{ item.author or 'Unknown' }}.`).length;
    const lengths = paras.map(p => p.textContent.length);
    const totalLen = introLen + lengths.reduce((s,n)=>s+n,0);
    let acc = introLen;
    boundaries = lengths.map(len => {
      const t = (acc/totalLen)*dur;
      acc += len;
      return t;
    });
    // show total time
    const m = Math.floor(dur/60), s = Math.floor(dur%60).toString().padStart(2,'0');
    totalTimeEl.textContent = `${m}:${s}`;
  });

  // update progress & highlight
  audio.addEventListener('timeupdate', () => {
    const t = audio.currentTime, pct = t/audio.duration*100;
    prog.value = pct;
    // find paragraph index
    let idx = boundaries.findIndex(b => t <= b);
    if (idx < 0) idx = boundaries.length - 1;
    if (idx !== lastIdx) {
      paras.forEach((p,i) => {
        const on = i === idx;
        p.classList.toggle('bg-yellow-100', on);
        p.classList.toggle('dark:bg-yellow-800', on);
        p.classList.toggle('p-2', on);
        p.classList.toggle('rounded', on);
      });
      if (idx >= 0) paras[idx].scrollIntoView({ behavior:'smooth', block:'center' });
      lastIdx = idx;
    }
    // update current time
    const m = Math.floor(t/60), s = Math.floor(t%60).toString().padStart(2,'0');
    curTimeEl.textContent = `${m}:${s}`;
  });

  // progress bar seek
  prog.addEventListener('click', e => {
    const pct = e.offsetX / prog.offsetWidth;
    audio.currentTime = pct * audio.duration;
  });

  // keyboard shortcuts
  document.addEventListener('keydown', e => {
    // avoid when typing in inputs
    if (['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
    switch (e.code) {
      case 'Space':
        e.preventDefault();
        audio.paused ? audio.play() : audio.pause();
        break;
      case 'ArrowRight':
        audio.currentTime = Math.min(audio.currentTime + 10, audio.duration);
        break;
      case 'ArrowLeft':
        audio.currentTime = Math.max(audio.currentTime - 10, 0);
        break;
      case 'ArrowUp':
        audio.volume = Math.min(audio.volume + 0.1, 1);
        break;
      case 'ArrowDown':
        audio.volume = Math.max(audio.volume - 0.1, 0);
        break;
      case 'Period': // '>' key
        {
          const cur = audio.playbackRate;
          const i = rateOptions.indexOf(cur);
          if (i < rateOptions.length-1) setSpeed(rateOptions[i+1]);
        }
        break;
      case 'Comma': // '<' key
        {
          const cur = audio.playbackRate;
          const i = rateOptions.indexOf(cur);
          if (i > 0) setSpeed(rateOptions[i-1]);
        }
        break;
    }
  });

  // ... (your existing share buttons, tag editor, font-size code here) ...
});
</script>
{% endblock %}