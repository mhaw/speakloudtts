{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div data-theme="admin" class="max-w-7xl mx-auto py-10 px-4 bg-base-100 rounded-box shadow-lg">
  <h1 class="text-2xl font-bold mb-6 text-base-content">Admin Dashboard</h1>
  <p class="mb-2 text-sm text-base-content/80">Total articles: <span class="font-semibold">{{ total_count }}</span></p>

  {% if stuck_items and stuck_items|length > 0 %}
    <div class="mb-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded flex items-center">
      <span class="font-semibold">{{ stuck_items|length }}</span> item(s) stuck in processing.
      <button class="ml-4 px-3 py-1 rounded bg-yellow-400 text-white hover:bg-yellow-500" id="retry-stuck">Retry All</button>
    </div>
  {% endif %}

  <form id="bulk-action-form" class="mb-3 flex flex-wrap gap-2 items-center">
    <select id="bulk-action" class="select select-bordered select-sm">
      <option value="">Bulk Action</option>
      <option value="publish">Publish</option>
      <option value="unpublish">Unpublish</option>
      <option value="reprocess">Reprocess</option>
      <option value="delete">Delete</option>
    </select>
    <button type="button" id="apply-bulk" class="btn btn-sm btn-primary" disabled>Apply</button>
    <span id="selected-count" class="text-sm ml-2 text-base-content/80"></span>
  </form>

  <!-- Search and Filter Form -->
  <form method="GET" action="{{ url_for('admin.dashboard') }}" class="mb-4 p-4 bg-base-200 rounded-box">
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div>
        <label for="search_term" class="label-text">Search Term</label>
        <input type="text" name="search_term" id="search_term" value="{{ search_term or '' }}" class="input input-bordered w-full" placeholder="URL, title, ID...">
      </div>
      <div>
        <label for="status_filter" class="label-text">Status</label>
        <select name="status_filter" id="status_filter" class="select select-bordered w-full">
          <option value="">All Statuses</option>
          <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Done</option>
          <option value="processing" {% if status_filter == 'processing' %}selected{% endif %}>Processing</option>
          <option value="error" {% if status_filter == 'error' %}selected{% endif %}>Error</option>
          <option value="queued" {% if status_filter == 'queued' %}selected{% endif %}>Queued</option>
        </select>
      </div>
      <div class="flex items-end">
        <button type="submit" class="btn btn-primary">Filter</button>
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-ghost ml-2">Clear</a>
      </div>
    </div>
  </form>

  <div class="flex justify-end items-center mb-3">
    <div class="join">
      <a href="{{ url_for('admin.dashboard') }}" class="join-item btn btn-sm {% if not request.args.get('start_after') %}btn-disabled{% endif %}">&larr; First</a>
      <a href="{{ url_for('admin.dashboard', start_after=next_page_cursor, search_term=search_term, status_filter=status_filter) }}" id="next-page" class="join-item btn btn-sm {% if not next_page_cursor %}btn-disabled{% endif %}">Next &rarr;</a>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table id="admin-table" class="table table-zebra table-xs sm:table-sm w-full">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all" class="checkbox checkbox-primary"></th>
          <th>ID</th>
          <th>Title</th>
          <th>Status</th>
          <th class="hidden sm:table-cell">Extractor</th>
          <th>Published</th>
          <th class="hidden sm:table-cell">Voice</th>
          <th class="hidden md:table-cell">Publish Date</th>
          <th class="hidden md:table-cell">Words</th>
          <th class="hidden lg:table-cell">IP</th>
          <th class="hidden lg:table-cell">Submitted</th>
          <th class="hidden lg:table-cell">Size</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr class="hover">
          <td><input type="checkbox" class="select-item checkbox checkbox-primary" value="{{ item.id }}"></td>
          <td class="break-all text-xs">{{ item.id }}</td>
          <td>
            <a href="{{ url_for('main.item_detail', item_id=item.id) }}" class="font-medium link link-hover">
              {{ item.title or "Untitled" }}
            </a>
            {% if item.error_message %}
              <div class="tooltip tooltip-bottom tooltip-error" data-tip="{{ item.error_message }}">
                <span class="block text-xs text-error/80">Error</span>
              </div>
            {% endif %}
            {% if item.extract_status %}
               <div class="tooltip tooltip-bottom" data-tip="{{ item.extract_status }}">
                <span class="block text-xs text-base-content/50">Extract Details</span>
              </div>
            {% endif %}
          </td>
          <td>
            <div class="badge badge-sm
              {% if item.status == 'done' %}badge-success
              {% elif item.status == 'processing' %}badge-warning
              {% elif item.status == 'error' or item.status == 'failed' %}badge-error
              {% else %}badge-ghost
              {% endif %}">
              {{ item.status or "—" }}
            </div>
          </td>
          <td class="hidden sm:table-cell"><span class="badge badge-ghost badge-sm">{{ item.source or 'n/a' }}</span></td>
          <td>
            {% if item.published %}
              <span class="font-semibold text-success">Yes</span>
            {% else %}
              <span class="text-base-content/70">No</span>
            {% endif %}
          </td>
          <td class="hidden sm:table-cell">{{ item.voice or "—" }}</td>
          <td class="hidden md:table-cell">{{ item.publish_date_fmt or "N/A" }}</td>
          <td class="hidden md:table-cell">{{ item.word_count or "—" }}</td>
          <td class="hidden lg:table-cell">{{ item.submitted_ip or "—" }}</td>
          <td class="hidden lg:table-cell">{{ item.submitted_at_fmt or "—" }}</td>
          <td class="hidden lg:table-cell">{{ item.storage_bytes or "—" }}</td>
          <td class="flex flex-wrap gap-1">
            <a href="{{ url_for('main.item_detail', item_id=item.id) }}" class="btn btn-xs btn-ghost">View</a>
            <button type="button" class="reprocess-btn btn btn-xs btn-ghost text-warning" data-id="{{ item.id }}">Reprocess</button>
            <button type="button" class="delete-btn btn btn-xs btn-ghost text-error" data-id="{{ item.id }}">Delete</button>
            {% if item.status == 'error' or item.status == 'processing' %}
              <button type="button" class="retry-btn btn btn-xs btn-ghost text-accent" data-id="{{ item.id }}">Retry</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not items %}
        <tr>
          <td colspan="12" class="text-center py-4">No articles found.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <div class="mt-12">
    <h2 class="text-xl font-bold mb-4 text-base-content">Recent Article Processing Failures</h2>
    {% if processing_failures %}
    <div class="overflow-x-auto">
      <table class="table table-zebra table-xs w-full">
        <thead>
          <tr>
            <th>Failed</th>
            <th>URL</th>
            <th>User ID</th>
            <th>Stage</th>
            <th>Error</th>
            <th>Original Item</th>
          </tr>
        </thead>
        <tbody>
          {% for failure in processing_failures %}
          <tr class="hover">
            <td class="text-xs">{{ failure.failed_at_human }}</td>
            <td class="break-all max-w-xs truncate"><a href="{{ failure.url }}" target="_blank" rel="noopener noreferrer" class="link link-hover">{{ failure.url }}</a></td>
            <td class="text-xs">{{ failure.user_id or 'N/A' }}</td>
            <td><span class="badge badge-warning">{{ failure.stage }}</span></td>
            <td class="text-error text-xs max-w-sm truncate">{{ failure.error_message }}</td>
            <td class="flex gap-1">
              <a href="{{ url_for('main.item_detail', item_id=failure.item_id) }}" class="btn btn-xs btn-ghost">View</a>
              <button type="button" class="retry-btn btn btn-xs btn-ghost text-accent" data-id="{{ failure.item_id }}">Retry</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-base-content/70">No processing failures recorded recently. Great job!</p>
    {% endif %}
  </div>

  <div id="toast-container" class="toast toast-bottom toast-end"></div>
</div>
<script src="{{ url_for('static', filename='js/admin.js', v=build_id) }}"></script>
{% endblock %}