{% extends "base.html" %}
{% block content %}
  <h2 class="text-2xl font-semibold mb-4">Submit an Article URL</h2>

  <form id="submit-form" class="space-y-4">
    <input 
      type="url" 
      id="url-input" 
      placeholder="https://example.com/article" 
      class="w-full px-4 py-2 border rounded focus:outline-none focus:ring" 
      required
      autofocus
    >
    <button 
      type="submit" 
      id="submit-btn"
      class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
    >
      Convert to Audio
    </button>
  </form>

  <div id="status" class="mt-4 min-h-[2em] text-gray-700 dark:text-gray-300"></div>

  <hr class="my-8">

  <section id="recent-section">
    <h3 class="text-xl font-medium mb-2">Recent Articles</h3>
    <ul id="recent-list" class="list-disc list-inside space-y-1 text-blue-600 dark:text-blue-400">
      <!-- populated by JS -->
    </ul>
  </section>

  <script>
    const form      = document.getElementById('submit-form');
    const input     = document.getElementById('url-input');
    const btn       = document.getElementById('submit-btn');
    const statusDiv = document.getElementById('status');

    async function loadRecent() {
      try {
        const res   = await fetch('/api/recent');
        const items = await res.json();
        const ul    = document.getElementById('recent-list');
        ul.innerHTML = '';
        items.forEach(i => {
          const li = document.createElement('li');
          const a  = document.createElement('a');
          a.href       = `/items/${i.id}`;
          a.textContent= i.title;
          a.className  = 'hover:underline';
          li.append(a);
          ul.append(li);
        });
      } catch (e) {
        // fail silently
      }
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      statusDiv.innerHTML = `<div class="flex items-center space-x-2 text-gray-600 dark:text-gray-400">
        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10"
                  stroke="currentColor" stroke-width="4" fill="none"/>
          <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8v8H4z"/>
        </svg>
        <span>Submitting URL…</span>
      </div>`;
      btn.disabled = true;
      input.disabled = true;

      const url = input.value.trim();
      if (!url) {
        statusDiv.innerHTML = `<p class="text-red-600">Please enter a valid URL.</p>`;
        btn.disabled = false;
        input.disabled = false;
        return;
      }

      try {
        // 1) Submit to server
        statusDiv.innerHTML = `<p>Validating &amp; extracting…</p>`;
        const res  = await fetch('/submit', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({url})
        });
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.detail || data.error ||
            'Unexpected server response.');
        }

        // 2) Show next step
        statusDiv.innerHTML = `<p>Great! Generating audio (this can take a minute)…</p>`;

        // 3) Poll for completion
        const itemId = data.item_id;
        let attempts = 0;
        while (attempts < 30) {
          await new Promise(r => setTimeout(r, 2000));
          const st = await fetch(`/api/items/${itemId}`);
          if (st.status === 200) {
            const info = await st.json();
            if (info.status === 'done') {
              window.location.href = `/items/${itemId}`;
              return;
            }
            if (info.status === 'error') {
              throw new Error(info.error || 'TTS generation failed');
            }
            statusDiv.innerHTML = `<p>Still processing… (${info.status})</p>`;
          }
          attempts++;
        }

        throw new Error('Took too long – please check back later.');
      }
      catch(err) {
        console.error(err);
        statusDiv.innerHTML = `
          <div class="text-red-600">
            <strong>Error:</strong> ${err.message}
            <p class="mt-2 text-sm">Tip: Try a different article URL or check the console for details.</p>
          </div>`;
      }
      finally {
        btn.disabled   = false;
        input.disabled = false;
      }
    });

    // load recent on page load
    loadRecent();
  </script>
{% endblock %}