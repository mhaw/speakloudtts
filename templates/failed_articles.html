{% extends "base.html" %}
{% block title %}Failed Articles{% endblock %}

{% block content %}
<div data-theme="admin" class="max-w-7xl mx-auto py-10 px-4 bg-base-100 rounded-box shadow-lg">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-base-content">Failed Articles</h1>
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-sm btn-ghost">‚Üê Back to Admin</a>
  </div>

  <!-- Errors table -->
  <div class="overflow-x-auto">
    <table class="table table-zebra table-sm w-full">
      <thead>
        <tr>
          <th>Article</th>
          <th>Error</th>
          <th class="hidden md:table-cell">Submitted</th>
          <th>Extraction Details</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="errors-body">
        {% for item in errors %}
        <tr class="hover">
          <td>
            <div class="font-bold">{{ item.title or "Untitled" }}</div>
            <div class="text-xs opacity-70 truncate max-w-xs">
              <a href="{{ item.url }}" target="_blank" rel="noopener noreferrer" class="link link-hover">{{ item.url }}</a>
            </div>
          </td>
          <td class="max-w-sm">
            <div class="tooltip tooltip-bottom" data-tip="{{ item.error_message }}">
              <span class="text-error text-xs truncate">{{ item.error_message }}</span>
            </div>
          </td>
          <td class="hidden md:table-cell text-xs">{{ item.submitted_at_human }}</td>
          <td>
            {% if item.extract_status %}
              <ul class="text-xs space-y-1">
                {% for extractor, status in item.extract_status.items() %}
                  <li>
                    {% if 'success' in status %}
                      <span class="badge badge-xs badge-success mr-2"></span>
                    {% elif 'pending' in status %}
                      <span class="badge badge-xs badge-ghost mr-2"></span>
                    {% else %}
                      <span class="badge badge-xs badge-error mr-2"></span>
                    {% endif %}
                    <span class="font-mono">{{ extractor }}</span>:
                    <span class="opacity-70">{{ status }}</span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <span class="text-xs opacity-50">No details</span>
            {% endif %}
          </td>
          <td class="flex flex-wrap gap-1">
            <a href="{{ url_for('main.item_detail', item_id=item.id) }}" class="btn btn-xs btn-ghost">View</a>
            <button type="button" class="retry-btn btn btn-xs btn-ghost text-accent" data-id="{{ item.id }}">Retry</button>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="text-center py-4">No failed articles found. Hooray!</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // The retry logic from admin.js can be used here if we align the endpoints.
  // For now, keeping the retry simple as it was in the original file, but pointing to the right place.
  document.getElementById('errors-body').addEventListener('click', async (e) => {
    const button = e.target.closest('.retry-btn');
    if (!button) return;

    e.preventDefault();
    const id = button.dataset.id;
    const row = button.closest('tr');
    
    button.classList.add('loading');
    button.disabled = true;

    try {
      const res = await fetch(`/admin/retry/${id}`, { method: 'POST' });
      const resData = await res.json();
      if (!res.ok || !resData.success) throw new Error(resData.error?.message || 'Unknown error');
      
      // On success, fade out and remove the row
      row.style.transition = 'opacity 0.5s';
      row.style.opacity = '0';
      setTimeout(() => row.remove(), 500);

    } catch (err) {
      console.error(`Failed to retry item ${id}:`, err);
      button.textContent = 'Failed';
      setTimeout(() => {
        button.textContent = 'Retry';
        button.classList.remove('loading');
        button.disabled = false;
      }, 2000);
    }
  });
});
</script>
{% endblock %}
